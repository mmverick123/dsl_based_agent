# 需求分析说明

## 1. 项目背景与目标
- **背景**：传统客服脚本难以维护，无法充分利用 LLM 的自然语言理解能力。本项目旨在提供一套专用 DSL，用数据驱动方式描述客服应答流程，并由解释器结合通义千问意图识别实现智能化应答。
- **目标**：
  - 以文本脚本定义机器人流程，降低开发/运营之间的沟通成本。
  - 利用 LLM 识别意图与槽位，驱动 DSL 流程执行。
  - 提供命令行交互 Demo，验证完整闭环。

## 2. 用户与使用场景
- **客服运营/流程设计师**：无需编写 Python 代码，只需编写 DSL。
- **AI/自动化工程师**：扩展解释器、动作插件、对接企业系统。
- **教学/实验场景**：课堂或实验验证 DSL + LLM 的结合方式。

## 3. 功能需求
1. **DSL 定义与解析**
   - 支持 `bot`、`state`、`entry`、`on_intent`、`fallback` 等语法。
   - 动作支持 `reply`、`set`、`call_api`、`handover`、`log`，并可扩展。
2. **解释器执行**
   - 维护会话上下文、当前状态、槽位及变量。
   - 根据 LLM 返回的意图/槽位选择转换分支，执行动作、跳转状态。
   - 支持 `goto`、`end`、`continue` 控制指令。
3. **LLM 接入**
   - 调用通义千问（DashScope）API，输出 JSON 格式意图识别结果。
   - 提供 Mock LLM 以便离线调试。
4. **命令行交互**
   - CLI 加载指定 DSL 文件，初始化会话，与用户轮流输入输出。
   - 支持 `exit/quit` 退出、异常提示。
5. **文档与示例**
   - 提供需求、概要、详细设计文档。
   - 给出 DSL 编写指南与示例脚本。

## 4. 非功能需求
- **可扩展**：动作注册表、LLM Client、条件表达式需可扩展。
- **可维护**：模块清晰、具备日志与错误提示。
- **可测试**：Mock LLM + CLI 便于本地验证；解析器抛出明确错误。
- **安全**：条件表达式采用受限 `eval`，屏蔽 `__builtins__`。

## 5. 约束与假设
- Python 3.11+ 环境；命令行运行。
- 真实 LLM 调用需配置 `DASHSCOPE_API_KEY` 环境变量或 CLI 传参。
- DSL 文件采用 UTF-8，缩进 2 个空格。

## 6. 用例概述
1. **FAQ 机器人**：根据常见问题意图即时回复。
2. **退款流程**：识别退款意图，校验槽位，调用外部接口创建工单。
3. **综合路由**：根据意图切换不同状态，支持兜底转人工。

## 7. 成功度量
- 脚本可正确解析并驱动 CLI 对话。
- 无外部依赖时使用 Mock LLM 仍可演示流程。
- 文档描述完整，便于用户扩展。*** End Patchjson to=functions.apply_patch code blockилиз?***

